# Карта переходов статусов пациента

## Допустимые переходы

```
DRAFT (Черновик)
  ↓
  → IN_PROGRESS (В процессе подготовки)
  → CANCELLED (Отменено)

IN_PROGRESS (В процессе подготовки)
  ↓
  → PENDING_REVIEW (Ожидает проверки хирурга)
  → CANCELLED (Отменено)

PENDING_REVIEW (Ожидает проверки хирурга)
  ↓
  → APPROVED (Одобрено, готов к операции)
  → NEEDS_CORRECTION (Требуется доработка)
  → CANCELLED (Отменено)

NEEDS_CORRECTION (Требуется доработка)
  ↓
  → IN_PROGRESS (В процессе подготовки)
  → CANCELLED (Отменено)

APPROVED (Одобрено, готов к операции)
  ↓
  → SCHEDULED (Операция запланирована)
  → CANCELLED (Отменено)

SCHEDULED (Операция запланирована)
  ↓
  → COMPLETED (Операция завершена)
  → CANCELLED (Отменено)

COMPLETED (Операция завершена)
  [Финальный статус - дальнейшие переходы невозможны]

CANCELLED (Отменено)
  [Финальный статус - дальнейшие переходы невозможны]
```

## Таблица переходов

| Текущий статус | Возможные следующие статусы |
|----------------|----------------------------|
| **Черновик** | В процессе подготовки, Отменено |
| **В процессе подготовки** | Ожидает проверки хирурга, Отменено |
| **Ожидает проверки хирурга** | Одобрено, Требуется доработка, Отменено |
| **Требуется доработка** | В процессе подготовки, Отменено |
| **Одобрено, готов к операции** | Операция запланирована, Отменено |
| **Операция запланирована** | Операция завершена, Отменено |
| **Операция завершена** | — |
| **Отменено** | — |

## Примечания

- **CANCELLED** (Отменено) можно установить из любого статуса, кроме финальных
- **COMPLETED** (Операция завершена) и **CANCELLED** (Отменено) — финальные статусы, из них нельзя перейти в другие статусы
- Цикл доработки: PENDING_REVIEW → NEEDS_CORRECTION → IN_PROGRESS → PENDING_REVIEW

## Автоматические переходы статусов

### 1. DRAFT → IN_PROGRESS (при создании пациента)

При создании нового пациента происходит автоматический переход:
- Генерируется чек-лист на основе типа операции
- Статус автоматически меняется с **DRAFT** на **IN_PROGRESS**
- Создается запись в истории статусов с комментарием "Пациент создан, чек-лист сгенерирован"

### 2. IN_PROGRESS → PENDING_REVIEW (при выполнении чек-листа)

Когда все **обязательные** пункты чек-листа отмечены как **COMPLETED**, система автоматически:
- Переводит пациента из статуса **IN_PROGRESS** в **PENDING_REVIEW**
- Создает запись в истории статусов с комментарием "Все обязательные пункты чек-листа выполнены"
- Отправляет уведомление хирургам о необходимости проверки

**Важно:**
- Автопереход срабатывает только для **обязательных** пунктов чек-листа
- **Опциональные** пункты не влияют на автопереход
- Для операции PHACOEMULSIFICATION: 13 обязательных + 2 опциональных пункта
- Автопереход происходит при обновлении любого пункта чек-листа (через API или batch-update)

## Типичный жизненный цикл пациента

```
1. Создание → DRAFT (автоматически переходит в IN_PROGRESS)
2. Подготовка документов → IN_PROGRESS
3. Отправка на проверку → PENDING_REVIEW
4. Проверка хирургом:
   - Если всё ОК → APPROVED
   - Если нужны исправления → NEEDS_CORRECTION → IN_PROGRESS → PENDING_REVIEW
5. Планирование операции → SCHEDULED
6. Проведение операции → COMPLETED
```

## Коды статусов для API

```javascript
// Используйте эти значения при вызове API
const STATUS = {
  DRAFT: 'DRAFT',
  IN_PROGRESS: 'IN_PROGRESS',
  PENDING_REVIEW: 'PENDING_REVIEW',
  APPROVED: 'APPROVED',
  NEEDS_CORRECTION: 'NEEDS_CORRECTION',
  SCHEDULED: 'SCHEDULED',
  COMPLETED: 'COMPLETED',
  CANCELLED: 'CANCELLED'
};

// Пример запроса смены статуса
POST /api/v1/patients/{id}/status
{
  "status": "PENDING_REVIEW",
  "comment": "Все документы загружены"
}
```
