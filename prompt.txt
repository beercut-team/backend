# ПРОМПТ: Бэкенд для платформы «Окулус-Фельдшер»

---

## ЧТО ЭТО ТАКОЕ И ЗАЧЕМ

Мы делаем веб-приложение для офтальмологической больницы **Республики Саха (Якутия)**. Суть простая: есть Якутская республиканская офтальмологическая больница в **Якутске**, где делают операции на глазах (катаракта, глаукома и т.д.). И есть **34 улуса (района)** по всей республике — от Нерюнгри до Тикси, от Мирного до Среднеколымска. Расстояния ебанутые — Якутия это 3 миллиона квадратных километров, самый большой регион в мире. До некоторых улусов добраться можно только самолётом или по зимнику. Дороги с твёрдым покрытием есть только в 16 улусах из 34. Интернет в сёлах хуёвый.

Сейчас бедные бабушки и дедушки из какого-нибудь Верхоянска или Оймякона (полюс холода, -60°C зимой) таскаются по 5 раз в Якутск, чтобы сдать предоперационные анализы и получить допуск к операции. Каждая поездка — это дни в дороге и куча денег. Наше приложение убирает эту хуйню — улусный врач заполняет всё онлайн, хирург в Якутске проверяет удалённо, и пациент приезжает один раз — сразу на операцию.

### КОНТЕКСТ РЕГИОНА (ВАЖНО ДЛЯ ПОНИМАНИЯ)
- **Центральная больница:** г. Якутск (столица РС(Я))
- **Районы** в Якутии называются **улусами** — это одно и то же
- В системе вместо слова «район» везде используем «улус»
- Всего **34 улуса** + город Якутск (республиканского значения)
- 13 улусов входят в **Арктическую зону** — там совсем жопа с дорогами и связью
- Оффлайн-режим критически важен — в сёлах (наслегах) интернет может пропадать на часы

---

## РОЛИ В СИСТЕМЕ (ВАЖНО — ЗАПОМНИ ВСЕ)

В системе **4 роли** (не 3, а именно 4 — четвёртая это колл-центр):

### 1. Улусный офтальмолог (Фельдшер)
- Это главный юзер системы
- Сидит в улусной больнице или ФАПе (фельдшерско-акушерский пункт) где-нибудь в Амге или Вилюйске, заполняет данные пациента
- Загружает анализы, снимки глаз, ЭКГ и прочее
- Отмечает галочки в чек-листе подготовки к операции
- Использует калькулятор ИОЛ (интраокулярная линза — это искусственный хрусталик)
- Получает комментарии/замечания от хирурга и исправляет

### 2. Хирург (Куратор в Якутской республиканской офтальмологической больнице)
- Сидит в Якутске, в республиканской больнице
- Видит список ВСЕХ пациентов из ВСЕХ улусов
- Проверяет загруженные анализы и снимки
- Если всё ок — нажимает «Подтвердить готовность» и назначает дату операции
- Если нет — пишет комментарий улусному врачу, что нужно доделать (например: «сахар высокий, отправьте к эндокринологу»)

### 3. Пациент (ограниченный доступ)
- Видит только СВОЙ статус подготовки (типа светофор: красный/жёлтый/зелёный)
- Видит дату операции, когда её назначат
- Получает уведомления через Telegram-бота (напоминания сдать анализы и т.д.)
- НЕ может ничего редактировать — только смотреть

### 4. Оператор колл-центра
- Это человек, который сидит на телефоне в республиканской больнице в Якутске
- Может создавать и редактировать карточки пациентов (если бабушка из Олёкминска позвонила и надо записать)
- Может просматривать статусы пациентов и отвечать на вопросы по телефону
- Может привязывать пациента к конкретному улусному врачу
- Может отправлять уведомления пациентам вручную (через систему)
- Может менять даты и время, координировать расписание
- По сути — это «секретарь» системы, который помогает и врачам и пациентам, но НЕ принимает медицинских решений (не может подтвердить готовность к операции — это только хирург)

---

## ТЕХНОЛОГИЧЕСКИЙ СТЕК

- **Язык:** Python
- **Фреймворк:** Django + Django REST Framework (DRF)
- **База данных:** PostgreSQL
- **Аутентификация:** JWT-токены (djangorestframework-simplejwt)
- **Хранение файлов:** Локальное хранилище (media/) — в MVP без S3
- **Очередь задач:** Celery + Redis (для отправки уведомлений, сжатия картинок)
- **Telegram-бот:** python-telegram-bot (или aiogram)
- **API-документация:** drf-spectacular (Swagger/OpenAPI)

---

## СТРУКТУРА БАЗЫ ДАННЫХ (МОДЕЛИ)

### Модель `User` (расширяем стандартного юзера Django)

```
User:
  - id (PK, auto)
  - email (unique, обязательное)
  - password (хеш)
  - first_name (имя)
  - last_name (фамилия)
  - patronymic (отчество — строка, необязательное)
  - role (ENUM: 'district_doctor', 'surgeon', 'patient', 'call_center')
  - phone (строка, необязательное)
  - ulus (строка — название улуса, для врачей. Значения из справочника ULUSES)
  - organization (строка — название учреждения, например «Амгинская улусная больница»)
  - is_active (bool)
  - created_at (datetime)
  - updated_at (datetime)
```

### Модель `Patient` (карточка пациента — отдельно от User!)

```
Patient:
  - id (PK, auto)
  - user (FK -> User, nullable — пациент может быть не зарегистрирован)
  - first_name (имя)
  - last_name (фамилия)
  - patronymic (отчество)
  - birth_date (date)
  - snils (строка, 11 символов)
  - insurance_policy (строка — номер полиса ОМС)
  - phone (строка)
  - address (текст — адрес проживания)
  - ulus (строка — улус, из справочника ULUSES)
  - diagnosis_mkb (строка — код по МКБ-10, например H25.1)
  - diagnosis_text (текст — описание диагноза словами)
  - assigned_doctor (FK -> User, где role='district_doctor')
  - assigned_surgeon (FK -> User, где role='surgeon', nullable)
  - telegram_chat_id (строка, nullable — для бота)
  - created_by (FK -> User — кто создал карточку: врач или колл-центр)
  - created_at (datetime)
  - updated_at (datetime)
```

### Модель `OperationType` (типы операций)

```
OperationType:
  - id (PK, auto)
  - name (строка — например «Факоэмульсификация», «Антиглаукоматозная операция»)
  - code (строка, unique — короткий код)
  - description (текст)
  - checklist_template (JSON — шаблон чек-листа для этого типа операции)
```

### Модель `PreparationCase` (случай подготовки — ГЛАВНАЯ СУЩНОСТЬ)

```
PreparationCase:
  - id (PK, auto)
  - patient (FK -> Patient)
  - operation_type (FK -> OperationType)
  - status (ENUM: 'draft', 'in_progress', 'pending_review', 'needs_correction', 'approved', 'scheduled', 'completed', 'cancelled')
  - status_color (computed: 'red', 'yellow', 'green' — для фронтенда)
      * red = draft, needs_correction
      * yellow = in_progress, pending_review
      * green = approved, scheduled, completed
  - assigned_doctor (FK -> User)
  - assigned_surgeon (FK -> User, nullable)
  - operation_date (date, nullable — заполняет хирург)
  - operation_time (time, nullable)
  - surgeon_comment (текст, nullable — комментарий хирурга)
  - created_at (datetime)
  - updated_at (datetime)
```

### Модель `ChecklistItem` (пункт чек-листа)

```
ChecklistItem:
  - id (PK, auto)
  - case (FK -> PreparationCase)
  - title (строка — например «Анализ крови (глюкоза, гемоглобин)»)
  - description (текст — подробное описание, что нужно сделать)
  - item_type (ENUM: 'file_upload', 'date_input', 'checkbox', 'iol_calculation')
  - is_required (bool — обязательный ли пункт)
  - is_completed (bool — отметил ли врач)
  - completed_at (datetime, nullable)
  - completed_by (FK -> User, nullable)
  - order (integer — порядок отображения)
  - file (FileField, nullable — загруженный файл)
  - date_value (date, nullable — для пунктов типа date_input)
  - notes (текст, nullable — заметки врача)
```

### Модель `MediaFile` (загруженные файлы/снимки)

```
MediaFile:
  - id (PK, auto)
  - case (FK -> PreparationCase)
  - checklist_item (FK -> ChecklistItem, nullable)
  - file (FileField — путь к файлу)
  - original_filename (строка)
  - file_type (ENUM: 'blood_test', 'ecg', 'fluorography', 'therapist_report', 'eye_culture', 'slit_lamp_photo', 'fundus_photo', 'keratotopography', 'other')
  - file_size (integer — в байтах)
  - is_compressed (bool — сжат ли файл)
  - uploaded_by (FK -> User)
  - uploaded_at (datetime)
  - description (текст, nullable)
```

### Модель `IOLCalculation` (расчёт интраокулярной линзы)

```
IOLCalculation:
  - id (PK, auto)
  - case (FK -> PreparationCase)
  - eye (ENUM: 'left', 'right')
  - k1 (float — кератометрия 1, в диоптриях)
  - k2 (float — кератометрия 2, в диоптриях)
  - axial_length (float — осевая длина глаза в мм)
  - acd (float — глубина передней камеры в мм)
  - target_refraction (float — целевая рефракция, обычно 0 или -0.5)
  - formula_used (ENUM: 'SRK_T', 'Haigis', 'Holladay', 'HofferQ')
  - calculated_power (float — рассчитанная сила линзы в диоптриях)
  - calculated_by (FK -> User)
  - calculated_at (datetime)
  - notes (текст, nullable)
```

### Модель `Comment` (комментарии в карточке — переписка врач-хирург)

```
Comment:
  - id (PK, auto)
  - case (FK -> PreparationCase)
  - author (FK -> User)
  - text (текст)
  - is_system (bool — системный комментарий или от человека)
  - created_at (datetime)
```

### Модель `Notification` (уведомления)

```
Notification:
  - id (PK, auto)
  - recipient (FK -> User)
  - patient (FK -> Patient, nullable)
  - case (FK -> PreparationCase, nullable)
  - type (ENUM: 'status_change', 'new_comment', 'reminder', 'operation_scheduled', 'manual')
  - title (строка)
  - message (текст)
  - is_read (bool)
  - sent_via (ENUM: 'system', 'telegram', 'both')
  - sent_at (datetime, nullable)
  - created_at (datetime)
```

### Модель `AuditLog` (логирование действий — для медицины это критично)

```
AuditLog:
  - id (PK, auto)
  - user (FK -> User)
  - action (строка — что сделал: 'created_patient', 'uploaded_file', 'approved_case' и т.д.)
  - target_model (строка — на какой модели: 'Patient', 'PreparationCase' и т.д.)
  - target_id (integer)
  - details (JSON — доп. инфа)
  - ip_address (строка)
  - created_at (datetime)
```

---

## API ЭНДПОИНТЫ (ВСЕ ЧЕРЕЗ REST)

### Авторизация (`/api/auth/`)

```
POST   /api/auth/login/              — логин, возвращает JWT (access + refresh)
POST   /api/auth/refresh/            — обновить access-токен
POST   /api/auth/logout/             — разлогин (инвалидация refresh)
GET    /api/auth/me/                 — текущий юзер (профиль)
PUT    /api/auth/me/                 — обновить свой профиль
```

### Пациенты (`/api/patients/`)

```
GET    /api/patients/                — список пациентов (фильтрация по роли: врач видит своих, хирург — всех, колл-центр — всех. Фильтр по улусу!)
POST   /api/patients/               — создать пациента (доступ: district_doctor, call_center)
GET    /api/patients/{id}/           — карточка пациента
PUT    /api/patients/{id}/           — обновить данные (доступ: district_doctor, call_center)
DELETE /api/patients/{id}/           — мягкое удаление (только если нет активных кейсов)
GET    /api/patients/{id}/status/    — упрощённый статус для пациентского интерфейса (публичный по короткому коду)
```

### Случаи подготовки (`/api/cases/`)

```
GET    /api/cases/                   — список кейсов (с фильтрами: status, doctor, surgeon, ulus)
POST   /api/cases/                   — создать новый кейс (доступ: district_doctor, call_center)
GET    /api/cases/{id}/              — детали кейса с чек-листом
PUT    /api/cases/{id}/              — обновить кейс
PATCH  /api/cases/{id}/status/       — сменить статус кейса

POST   /api/cases/{id}/submit/       — врач отправляет на проверку хирургу (status -> pending_review)
POST   /api/cases/{id}/approve/      — хирург подтверждает готовность (status -> approved, доступ: surgeon)
POST   /api/cases/{id}/reject/       — хирург возвращает на доработку (status -> needs_correction, доступ: surgeon)
POST   /api/cases/{id}/schedule/     — хирург назначает дату операции (status -> scheduled, доступ: surgeon)
```

### Чек-лист (`/api/cases/{case_id}/checklist/`)

```
GET    /api/cases/{case_id}/checklist/           — все пункты чек-листа кейса
PATCH  /api/cases/{case_id}/checklist/{id}/      — обновить пункт (отметить выполненным, загрузить файл)
```

### Файлы (`/api/cases/{case_id}/files/`)

```
GET    /api/cases/{case_id}/files/       — список файлов кейса
POST   /api/cases/{case_id}/files/       — загрузить файл (multipart/form-data)
DELETE /api/cases/{case_id}/files/{id}/   — удалить файл
GET    /api/cases/{case_id}/files/{id}/download/  — скачать файл
```

### Калькулятор ИОЛ (`/api/cases/{case_id}/iol/`)

```
POST   /api/cases/{case_id}/iol/calculate/   — рассчитать ИОЛ (принимает K1, K2, ACD, axial_length, formula)
GET    /api/cases/{case_id}/iol/              — список расчётов для кейса
GET    /api/cases/{case_id}/iol/{id}/         — конкретный расчёт
```

### Комментарии (`/api/cases/{case_id}/comments/`)

```
GET    /api/cases/{case_id}/comments/    — список комментариев
POST   /api/cases/{case_id}/comments/    — добавить комментарий
```

### Уведомления (`/api/notifications/`)

```
GET    /api/notifications/               — мои уведомления
PATCH  /api/notifications/{id}/read/     — отметить как прочитанное
POST   /api/notifications/send/          — отправить уведомление вручную (доступ: call_center, surgeon)
```

### Типы операций (`/api/operation-types/`)

```
GET    /api/operation-types/             — список типов операций с шаблонами чек-листов
GET    /api/operation-types/{id}/        — конкретный тип
```

### Справочник улусов (`/api/uluses/`)

```
GET    /api/uluses/                      — список всех 34 улусов (для селектов на фронте)
GET    /api/uluses/{code}/               — конкретный улус с деталями (арктика, расстояние до Якутска и т.д.)
GET    /api/uluses/arctic/               — только арктические улусы (13 штук)
```

### Пациентский публичный эндпоинт

```
GET    /api/public/status/{short_code}/  — статус по короткому коду (без авторизации!)
```

### Статистика (для дашборда)

```
GET    /api/stats/dashboard/             — общая статистика (кол-во пациентов по статусам, по улусам и т.д.)
                                           Доступ: surgeon, call_center
GET    /api/stats/doctor/{id}/           — статистика конкретного врача
```

---

## ПРАВА ДОСТУПА (PERMISSIONS) — МАТРИЦА

```
Действие                    | Улусный врач  | Хирург | Колл-центр | Пациент
----------------------------|---------------|--------|------------|--------
Создать пациента            |      ✅       |   ❌   |     ✅     |   ❌
Редактировать пациента      |   ✅ (своих)  |   ❌   |     ✅     |   ❌
Смотреть пациентов          |   ✅ (своих)  |   ✅   |     ✅     |  ✅ (себя)
Создать кейс                |      ✅       |   ❌   |     ✅     |   ❌
Заполнять чек-лист          |   ✅ (своих)  |   ❌   |     ❌     |   ❌
Загружать файлы             |   ✅ (своих)  |   ❌   |     ❌     |   ❌
Подтвердить готовность      |      ❌       |   ✅   |     ❌     |   ❌
Назначить дату операции     |      ❌       |   ✅   |     ❌     |   ❌
Писать комментарии          |   ✅ (своих)  |   ✅   |     ✅     |   ❌
Отправлять уведомления      |      ❌       |   ✅   |     ✅     |   ❌
Видеть дашборд/статистику   |      ❌       |   ✅   |     ✅     |   ❌
Привязать пациента к врачу  |      ❌       |   ❌   |     ✅     |   ❌
Менять дату/время записи    |      ❌       |   ✅   |     ✅     |   ❌
Рассчитать ИОЛ              |      ✅       |   ✅   |     ❌     |   ❌
Видеть свой статус          |      ❌       |   ❌   |     ❌     |   ✅
```

---

## БИЗНЕС-ЛОГИКА (ПОДРОБНО)

### Жизненный цикл кейса (state machine):

```
draft → in_progress → pending_review → approved → scheduled → completed
                          ↓                ↑
                   needs_correction ───────┘
                   
В любой момент можно перевести в cancelled
```

1. Улусный врач создаёт пациента и кейс → статус `draft`
2. Врач начинает заполнять чек-лист → статус автоматически меняется на `in_progress`
3. Когда все обязательные пункты заполнены, врач нажимает «Отправить на проверку» → `pending_review`
4. Хирург проверяет:
   - Всё ок → `approved`
   - Есть проблемы → `needs_correction` + комментарий
5. Врач исправляет → снова `pending_review`
6. Хирург назначает дату → `scheduled`
7. После операции → `completed`

### Автоматическое создание чек-листа:

Когда создаётся кейс и выбирается тип операции — система автоматически генерирует чек-лист из шаблона `OperationType.checklist_template`. Шаблон — это JSON вида:

```json
[
  {
    "title": "Общий анализ крови",
    "description": "Глюкоза, гемоглобин, лейкоциты",
    "item_type": "file_upload",
    "is_required": true,
    "order": 1
  },
  {
    "title": "ЭКГ с расшифровкой",
    "description": "Загрузить файл ЭКГ и заключение кардиолога",
    "item_type": "file_upload",
    "is_required": true,
    "order": 2
  },
  ...
]
```

### Калькулятор ИОЛ — формула SRK/T:

```python
# Упрощённая формула SRK/T
# IOL_power = A - 2.5 * axial_length - 0.9 * avg_K

def calculate_srk_t(k1, k2, axial_length, a_constant=118.4, target_refraction=0):
    avg_k = (k1 + k2) / 2
    iol_power = a_constant - (2.5 * axial_length) - (0.9 * avg_k)
    iol_power -= target_refraction  # корректировка на целевую рефракцию
    return round(iol_power, 2)
```

Нужно реализовать минимум 2 формулы: SRK/T и Haigis. Результат сохраняется в модели IOLCalculation.

### Сжатие файлов:

При загрузке изображений (JPEG, PNG) — автоматически сжимать через Pillow:
- Если размер > 2MB — ресайз до 1920px по длинной стороне
- Качество JPEG: 80%
- Это делается через Celery-задачу асинхронно

### Telegram-бот:

- Пациент привязывает Telegram через короткий код (6 цифр)
- Бот отправляет уведомления: смена статуса, напоминания о анализах, дата операции
- Команды бота: `/status` — текущий статус, `/help` — справка

---

## СТРУКТУРА DJANGO-ПРОЕКТА

```
oculus_feldsher/
├── manage.py
├── requirements.txt
├── config/
│   ├── __init__.py
│   ├── settings/
│   │   ├── __init__.py
│   │   ├── base.py          # общие настройки
│   │   ├── development.py    # для разработки
│   │   └── production.py     # для прода
│   ├── urls.py
│   ├── wsgi.py
│   └── celery.py
├── apps/
│   ├── users/                # авторизация, юзеры, роли
│   │   ├── models.py
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── urls.py
│   │   ├── permissions.py    # кастомные пермишены
│   │   ├── admin.py
│   │   └── tests.py
│   ├── patients/             # пациенты
│   │   ├── models.py
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── urls.py
│   │   ├── permissions.py
│   │   └── tests.py
│   ├── cases/                # кейсы подготовки + чек-листы
│   │   ├── models.py
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── urls.py
│   │   ├── permissions.py
│   │   ├── services.py       # бизнес-логика (state machine, создание чек-листа)
│   │   └── tests.py
│   ├── media_files/          # загрузка и сжатие файлов
│   │   ├── models.py
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── urls.py
│   │   ├── tasks.py          # Celery-задачи (сжатие)
│   │   └── tests.py
│   ├── iol/                  # калькулятор ИОЛ
│   │   ├── models.py
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── urls.py
│   │   ├── calculator.py     # формулы SRK/T, Haigis и т.д.
│   │   └── tests.py
│   ├── notifications/        # уведомления + Telegram-бот
│   │   ├── models.py
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── urls.py
│   │   ├── tasks.py          # Celery: отправка в Telegram
│   │   ├── bot.py            # логика Telegram-бота
│   │   └── tests.py
│   ├── audit/                # логирование действий
│   │   ├── models.py
│   │   ├── middleware.py     # middleware для автологирования
│   │   └── tests.py
│   └── stats/                # статистика и дашборд
│       ├── views.py
│       ├── urls.py
│       └── services.py
├── common/
│   ├── pagination.py         # кастомная пагинация
│   ├── mixins.py             # общие миксины
│   └── utils.py              # утилиты
└── media/                    # загруженные файлы (не в git!)
```

---

## ЧТО НУЖНО СДЕЛАТЬ ПО ШАГАМ

### Шаг 1: Инициализация проекта
- Создать Django-проект с DRF
- Настроить PostgreSQL
- Настроить JWT-аутентификацию
- Создать кастомную модель User с полем role

### Шаг 2: Модели
- Создать все модели, описанные выше
- Написать миграции
- Создать фикстуры с тестовыми данными (минимум: 2 врача, 1 хирург, 1 оператор колл-центра, 5 пациентов, 2 типа операций с шаблонами чек-листов)

### Шаг 3: Сериализаторы
- Для каждой модели — минимум 2 сериализатора: List (краткий) и Detail (полный)
- Вложенные сериализаторы (кейс → чек-лист → файлы)
- Валидация данных (СНИЛС — 11 цифр, полис — 16 цифр, и т.д.)

### Шаг 4: Views и Permissions
- ViewSets для всех моделей
- Кастомные permissions на основе роли
- Фильтрация: улусный врач видит только своих пациентов, хирург — всех, колл-центр — всех
- Поиск по ФИО, СНИЛС, номеру полиса

### Шаг 5: Бизнес-логика
- State machine для кейсов (переходы между статусами)
- Автогенерация чек-листа при создании кейса
- Калькулятор ИОЛ (формулы SRK/T и Haigis)
- Сжатие загруженных изображений (Celery + Pillow)

### Шаг 6: Уведомления
- Модель уведомлений
- При смене статуса — автоматическое уведомление
- Telegram-бот: привязка, отправка уведомлений, команда /status
- Возможность ручной отправки (колл-центр, хирург)

### Шаг 7: Дополнительно
- Аудит-лог (middleware, пишет все действия)
- Swagger-документация (drf-spectacular)
- CORS настройки для фронтенда
- Генерация PDF «Лист маршрутизации пациента» (reportlab или weasyprint)

---

## ВАЖНЫЕ ДЕТАЛИ, КОТОРЫЕ ЛЕГКО ПРОЕБАТЬ

1. **Оффлайн-режим** — это забота фронтенда (PWA), но бэкенд должен поддерживать **batch-загрузку**: один POST-запрос с пачкой данных (несколько пунктов чек-листа + файлы за раз). Сделай эндпоинт `POST /api/cases/{id}/batch-update/`. В Якутии это КРИТИЧНО — врач из Батагая может заполнять формы оффлайн весь день и отправить всё одним запросом, когда появится связь.

2. **Короткий код для пациента** — генерируется автоматически при создании пациента (6 символов, буквы+цифры). По нему пациент может посмотреть свой статус без регистрации.

3. **FHIR-совместимость** — в MVP просто добавь текстовые поля `fhir_resource_id` в модели Patient и PreparationCase. Этого достаточно для «заглушки».

4. **ЕМИАС/РИАМС-заглушка** — сделай пустой сервис `emias_service.py` с методами `send_to_emias()` и `fetch_from_emias()`, которые просто логируют вызов и возвращают mock-данные. В Якутии используется РИАМС (региональная информационно-аналитическая медицинская система).

5. **Безопасность** — это медицинские данные, поэтому:
   - Все эндпоинты кроме `/api/public/` требуют авторизации
   - Файлы отдаются только авторизованным юзерам с правильной ролью (не через прямые ссылки!)
   - Аудит-лог пишет ВСЁ

6. **Колл-центр** — эта роль важна для реальной работы. Операторы в Якутске:
   - Принимают звонки от пациентов из улусов
   - Создают карточки за врачей (если врач позвонил)
   - Координируют расписание
   - Могут отправлять ручные уведомления
   - НО не могут принимать медицинские решения

7. **Часовые пояса** — Якутия раскинулась на 3 часовых пояса (МСК+6, МСК+7, МСК+8). В модели Ulus стоит хранить timezone. Все даты в БД — в UTC, конвертация на фронте.

8. **Привязка к улусу** — при создании пациента обязательно указывается улус. Хирург и колл-центр могут фильтровать пациентов по улусу. В дашборде должна быть статистика по улусам (кол-во пациентов, среднее время подготовки, и т.д.).

---

## ТЕСТОВЫЕ ДАННЫЕ (FIXTURES)

Создай management-команду `python manage.py seed_data`, которая создаёт:

- **Юзеры:**
  - Николаев Айсен Сергеевич — улусный офтальмолог, Амгинский улус (с. Амга), Амгинская улусная больница
  - Васильева Сардаана Ивановна — улусный офтальмолог, Вилюйский улус (г. Вилюйск), Вилюйская ЦУБ
  - Попов Дмитрий Егорович — улусный офтальмолог, Хангаласский улус (г. Покровск), Хангаласская ЦУБ
  - Слепцов Гаврил Николаевич — улусный офтальмолог, Верхоянский улус (п. Батагай), Верхоянская ЦУБ (арктическая зона!)
  - Фёдорова Мария Петровна — улусный офтальмолог, Мегино-Кангаласский улус (п. Нижний Бестях), МК улусная больница
  - Колесов Алексей Дмитриевич — хирург, г. Якутск, Якутская республиканская офтальмологическая больница
  - Борисова Туяра Афанасьевна — хирург, г. Якутск, Якутская республиканская офтальмологическая больница
  - Степанова Надежда Ильинична — оператор колл-центра, г. Якутск
  - Иванова Алина Михайловна — оператор колл-центра, г. Якутск

- **Пациенты (10 штук из разных улусов):**
  - Петров Егор Афанасьевич, 72 года, Амгинский улус, диагноз H25.1 (возрастная катаракта)
  - Алексеева Дария Николаевна, 68 лет, Вилюйский улус, диагноз H25.0 (начальная катаракта)
  - Сивцев Михаил Иннокентьевич, 75 лет, Хангаласский улус, диагноз H40.1 (открытоугольная глаукома)
  - Максимова Анна Семёновна, 80 лет, Верхоянский улус (арктика!), диагноз H25.2 (морганиева катаракта)
  - Кириллин Пётр Васильевич, 65 лет, Мегино-Кангаласский улус, диагноз H25.1
  - Софронова Ульяна Егоровна, 71 год, Намский улус, диагноз H40.2 (закрытоугольная глаукома)
  - Данилов Семён Прокопьевич, 78 лет, Чурапчинский улус, диагноз H25.1
  - Охлопкова Клавдия Дмитриевна, 69 лет, Усть-Алданский улус, диагноз H25.0
  - Тарасов Иван Степанович, 74 года, Горный улус (с. Бердигестях), диагноз H25.1
  - Габышева Людмила Фёдоровна, 67 лет, Олёкминский улус, диагноз H40.1

- **Типы операций:**
  - Факоэмульсификация (катаракта) — с полным шаблоном чек-листа
  - Антиглаукоматозная операция — с полным шаблоном чек-листа

- **Кейсы:**
  - 3 кейса в статусе `in_progress` (Амга, Вилюйск, Верхоянск)
  - 2 в `pending_review` (Хангалас, Мегино-Кангалас)
  - 2 в `approved` (Намцы, Чурапча)
  - 2 в `needs_correction` (Усть-Алдан, Горный)
  - 1 в `scheduled` (Олёкминск, дата операции через 2 недели)

---

## СПРАВОЧНИК УЛУСОВ РС(Я) (ПОЛНЫЙ СПИСОК — 34 улуса)

Этот список должен быть в БД как справочная таблица `Ulus` или как ENUM/choices. Используется в моделях User и Patient.

```python
ULUSES = [
    ('abyisky', 'Абыйский улус (п. Белая Гора)'),           # арктика
    ('aldansky', 'Алданский район (г. Алдан)'),
    ('allaikhovsky', 'Аллаиховский улус (п. Чокурдах)'),     # арктика
    ('amginsky', 'Амгинский улус (с. Амга)'),
    ('anabarsky', 'Анабарский улус (с. Саскылах)'),           # арктика, национальный
    ('bulunsky', 'Булунский улус (п. Тикси)'),                # арктика
    ('verkhnevilyuisky', 'Верхневилюйский улус (с. Верхневилюйск)'),
    ('verkhnekolymsky', 'Верхнеколымский улус (п. Зырянка)'), # арктика
    ('verkhoyansky', 'Верхоянский улус (п. Батагай)'),        # арктика
    ('vilyuisky', 'Вилюйский улус (г. Вилюйск)'),
    ('gorny', 'Горный улус (с. Бердигестях)'),
    ('zhigansky', 'Жиганский улус (п. Жиганск)'),            # арктика, национальный
    ('kobyaisky', 'Кобяйский улус (п. Сангар)'),
    ('lensky', 'Ленский район (г. Ленск)'),
    ('megino_kangalassky', 'Мегино-Кангаласский улус (п. Нижний Бестях)'),
    ('mirninsky', 'Мирнинский район (г. Мирный)'),
    ('momsky', 'Момский улус (с. Хонуу)'),                    # арктика
    ('namsky', 'Намский улус (с. Намцы)'),
    ('nerungri', 'Нерюнгринский район (г. Нерюнгри)'),
    ('nizhnekolymsky', 'Нижнеколымский улус (п. Черский)'),   # арктика
    ('nyurbinsky', 'Нюрбинский район (г. Нюрба)'),
    ('oimekonsky', 'Оймяконский улус (п. Усть-Нера)'),
    ('olekminsky', 'Олёкминский улус (г. Олёкминск)'),
    ('olenyoksky', 'Оленёкский улус (с. Оленёк)'),            # арктика, национальный
    ('srednekolymsky', 'Среднеколымский улус (г. Среднеколымск)'), # арктика
    ('suntarsky', 'Сунтарский улус (с. Сунтар)'),
    ('tattinsky', 'Таттинский улус (с. Ытык-Кюёль)'),
    ('tomponsky', 'Томпонский район (п. Хандыга)'),
    ('ust_aldansky', 'Усть-Алданский улус (с. Борогонцы)'),
    ('ust_maisky', 'Усть-Майский улус (п. Усть-Мая)'),
    ('ust_yansky', 'Усть-Янский улус (п. Депутатский)'),      # арктика
    ('khangalassky', 'Хангаласский улус (г. Покровск)'),
    ('churapchinsky', 'Чурапчинский улус (с. Чурапча)'),
    ('eveno_bytantaisky', 'Эвено-Бытантайский улус (с. Батагай-Алыта)'), # арктика, национальный
]

# Отдельно — город Якутск (республиканского значения, не улус)
# ('yakutsk', 'ГО «Город Якутск»')
```

### Модель `Ulus` (справочник улусов — отдельная таблица)

```
Ulus:
  - id (PK, auto)
  - code (строка, unique — 'amginsky', 'vilyuisky' и т.д.)
  - name (строка — «Амгинский улус»)
  - center (строка — «с. Амга»)
  - is_arctic (bool — входит ли в Арктическую зону РФ)
  - is_national (bool — национальный улус)
  - latitude (float, nullable — координаты центра, для карты)
  - longitude (float, nullable)
  - has_stable_internet (bool — есть ли стабильный интернет, влияет на рекомендации по оффлайн-режиму)
  - distance_to_yakutsk_km (integer — расстояние до Якутска в км, для аналитики)
```

Эта таблица заполняется через фикстуру при первом запуске и используется как FK в User.ulus и Patient.ulus (вместо строки — внешний ключ на Ulus).

---

Вот и всё. Этот промпт содержит ВСЮ информацию, чтобы написать полноценный бэкенд для платформы «Окулус-Фельдшер» в контексте Республики Саха (Якутия). Все 34 улуса, арктическая зона, три часовых пояса, якутские имена в тестовых данных. Бери и делай по шагам — от моделей до API, от прав доступа до Telegram-бота.
Вот промпт, надо сделать так чтобы он проверил что сейчас есть, и исправил то что надо и документацию тоже обновил через scalar